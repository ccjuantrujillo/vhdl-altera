//EE604 O-P Lab 3, 2024-1
#include <stdio.h>
#include <unistd.h>
#include "system.h"
#include "alt_types.h"
#include "altera_avalon_pio_regs.h"

int main()
{
	unsigned char switches;
	unsigned char a = 0x00; // for BCD count up
	unsigned char b = 0x99; // for BCD count down
	unsigned char c = 0x01; // for shift left and right 1 bit on
	unsigned char d = 0x00; // 0x00 for shift left "c", 0x01 for shift right "c"

	printf("Hello from Nios II!\n");
	printf("EE604 Introduccion a Microcontroladores - 3er Laboratorio 2024-1\n");
	while (1) {
		switches = IORD(SWITCHES_BASE, 0);
		if (switches>=0x80) { // flashing "11" BCD pattern
			IOWR(LEDS_BASE, 0, 0x11);
			usleep(275*1000);
			IOWR(LEDS_BASE, 0, 0xFF);
			usleep(275*1000);
		}
		if (switches>=0x40 && switches<=0x7f) { // count down in BCD from 99 to 00
			IOWR(LEDS_BASE, 0, b);
			usleep(275*1000);
			b = b - 1;
			switch (b) {
				case 0xFF:
					b = 0x99;
					break;
				case 0x0F:
					b = 0x09;
					break;
				case 0x1F:
					b = 0x19;
					break;
				case 0x2F:
					b = 0x29;
					break;
				case 0x3F:
					b = 0x39;
					break;
				case 0x4F:
					b = 0x49;
					break;
				case 0x5F:
					b = 0x59;
					break;
				case 0x6F:
					b = 0x69;
					break;
				case 0x7F:
					b = 0x79;
					break;
				case 0x8F:
					b = 0x89;
					break;
			}
		}
		if (switches>=0x20 && switches<=0x3f) { // shift left and right 1 bit on
			IOWR(LEDS_BASE, 0, c);
			usleep(275*1000);
			if (d == 0x00) {
				c = c << 1;
				if (c == 0x00) {
					c = 0x80;
					d = 0x01;
				}
			}
			if (d == 0x01) {
				c = c >> 1;
				if (c == 0x00) {
					c = 0x02;
					d = 0x00;
				}
			}
		}
		if (switches>=0x10 && switches<=0x1f) { // count up in BCD from 00 to 99
			IOWR(LEDS_BASE, 0, a);
			usleep(275*1000);
			a = a + 1;
			switch (a) {
				case 0x0a:
					a = 0x10;
					break;
				case 0x1a:
					a = 0x20;
					break;
				case 0x2a:
					a = 0x30;
					break;
				case 0x3a:
					a = 0x40;
					break;
				case 0x4a:
					a = 0x50;
					break;
				case 0x5a:
					a = 0x60;
					break;
				case 0x6a:
					a = 0x70;
					break;
				case 0x7a:
					a = 0x80;
					break;
				case 0x8a:
					a = 0x90;
					break;
				case 0x9a:
					a = 0x00;
					break;
			}
		}
		if (switches>=0x00 && switches<=0x0f) { // do nothing
			IOWR(LEDS_BASE, 0, 0xFF);
			usleep(275*1000);
		}
	}
	return 0;
}
